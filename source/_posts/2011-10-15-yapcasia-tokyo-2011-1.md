---
title: YAPC::Asia Tokyo 2011 (1日目) に行ってきた
date: 2011-10-15 00:00:00 +0900
author: hatak
layout: post
permalink: /2011/10/15/6689
categories:
  - report
tags:
  - mysql
  - nginx
  - perl
  - security
  - yapc
---

Perl のおまつり、 [YAPC::Asia][1] に参加しています。
昨年はプライベートでドタバタしていたので、2 年ぶりの参加でした。前回に比べて参加者も多く、それでいてスムーズなイベント進行と素敵なトークの数々でとても楽しい時間を過ごしています。 ひとまず 1 日目を振り返りつつ、聞いたトークをまとめておこうと思いました。

振り返ると、インフラ寄りな内容を選んでいたこともありますが、今日は Perl に限らない話も多かったように思います。それだけ広い知識と経験が必要で、いろんな所でいろんなひとが挑戦していることがわかってわくわくしましたが！

<!--more-->

* * *

## Perl 5.16 and beyond

今回のスペシャルゲスト、 Perl5 開発リーダーの Jesse Vincent ([@obra][2]) さんの講演。Perl5 の開発プロセスがどのように変化してきたか、そして今後の Perl5 がどうなっていくのかというお話でした。 （英語のセッションだったので内容を頭の中で理解するのが追いつかずメモ取りきれなかったので間違えていたら指摘をお願いします。。）

### Pumpking

Perl5 の開発体制が整ってきたのでリリーススパンが早くなってきた。

* VCS を Git に変えた
* リリースをコミッタの持ち回りに
* 約 1 年で 5.12 → 5.14 そして Perl 開発マネージャーとしての仕事についての説明。
* Perl5 の方向性を決める
* 開発メンバーにタスクを振る
* 仕様に関する文書をまとめる つまり **&#8220;You make Perl&#8221;**

### Vision

&#8220;New version should not break old environment&#8221; と &#8220;Perl should run everywhere&#8221;

* 互換性を重視しつつ、進化は続ける
* use でバージョンを指定した場合はその指定されたバージョンの挙動に合わせる &#8211; 古い文法には極力沿うようにする &#8211; 指定されたバージョンよりも新しい機能は動かないようにする

そして機能をシンプルにして、仕様を明確化させる。

* Core の機能をモジュールとして分割する &#8211; &#8220;traditional&#8221; と &#8220;bootstrappable&#8221; の 2 種類のエディションに
* 別の言語でも再実装できるように &#8211; 生き残るために

* * *

## Webアプリケーション高速化

※講演資料 [YAPC::Asia 2011 / 高速化のはなしとか][3] ライブドアの mala ([@bulkneets][4]) さんの講演。すべてを聞いたあとの「気持よく書ける範囲で最適化」というまとめに納得しました。先回りしてキャッシュしておく戦略は難しそうですが、効果は大きそうなのでやってみたいと思っています。

### はじめに

* チューニングについてのスタンス &#8211; 努力だけでどうにもならないときは、卑怯な手段を使う &#8211; バレなきゃイカサマではない
* 方法はいろいろ &#8211; 頑張って高速化する「努力」 &#8211; そもそも処理しない「Hack」 &#8211; SSD など「財力」
* どの方法を選ぶかはケースバイケース &#8211; 適切な手段を選ぶことは必要 &#8211; ハードウェアはすごく早くはならない

### 一般的な方法

* ボトルネックを見つけてチューニング &#8211; リソースやスロークエリ等の監視 &#8211; プロファイリング &#8212; Devel::NYTProf / Devel::KYTProf &#8212; 計測用のスクリプトを作成しておく &#8212;- Shell::Perl が便利 &#8212; stopwatch で時間計測 &#8212;- benchmark だと CPU 時間を計測する &#8212;- 1 req の処理時間を測って感覚を把握できるようにする
* キャッシュや静的生成 &#8211; バックエンドに飛んだら負け &#8212; PSGI でも 数千 req/sec しかさばけない &#8212; Nginx などの静的レスポンスなら 数万 req/sec &#8211; 状況に応じてキャッシュを選択する &#8212; データ量・更新頻度・揮発性 &#8212; データ型サポート &#8212; 複数処理で使いまわすか
* コード &#8211; テクニックを抑えておく &#8212; 必要なデータはまとめて引いておく &#8212; 遅延評価 &#8212; MySQL では &#8220;WHERE IN&#8221; / &#8220;BULK UPDATE&#8221; の活用 &#8212; memcached では &#8220;get_multi&#8221; を使ってプロトコルオーバヘッド減らす

### あまり真似されない方法

#### Bloom Filter

* KVS / MySQL への問い合わせ前に大雑把なクエリを間引く &#8211; 精度はデータ量とのトレードオフ &#8211; <a href=&#8221;http://fallabs.com/blog-ja/promenade.cgi?id=70
* 存在しないキーを大量に問い合わせるケースで有効 &#8211; ブックマークのカウンタ &#8211; ブラウジング履歴調べる &#8211; 富豪的クエリ
* memcached への問い合わせなどでネガティブキャッシュを減らせる
* 使うのは CPU &#8211; パラメータにも依るが 数万 qps 処理できる &#8211; ハッシュよりは遅く、リモートの DB よりは早い

#### Cache warmup

* よく使われるデータを先に載せておく &#8211; MySQL innodb &#8211; memcached
* ユーザがページを表示した瞬間に id を Q4M に入れる &#8211; worker が先回りしてキャッシュに入れる
* ライトスルー方式との違い &#8211; 参照されそうなときに乗るのでヒットしやすい &#8211; キャッシュ生成がレスポンス生成より遅いと重くなる

#### Varnish + ESI

* 最近流行りの構成は Nginx + Standalone PSGI でいい
* Varnish が使えるポイント &#8211; 高速化 &#8211; vcl で書ける &#8211; ESI が使える &#8212; Akamai が開発した SSI のような仕組み
* ESI を使うとパーツごとにキャッシュできる &#8211; 利点 &#8212; フロントとバックエンド間の転送量節約できる &#8211; 問題点 （主に v2） &#8212; Varnish が Contents-Length 返してくれない &#8212; Varnish が ETag みてくれない &#8212; メモリが足りなくなくなると重くなる

* * *

## 新はてなダイアリーの裏側

はてなの大西 ([@yasuhiro_onishi][5]) さんの講演。はてなダイアリーが &#8220;Hatena Blog&#8221; にリニューアルを解説するセッションでした。主に表示に関わる仕様変更をユーザの行動に影響しないようにするため、様々な工夫をされているのですね。。

### 技術的な話

* 外部ドメイン化 / JS フリー化 &#8211; 従来ははてな共通ドメイン・ログインクッキー &#8211; 利点 &#8212; どのサービスでもログイン状態になれる &#8212; 編集 / 閲覧の区別がない &#8211; 欠点 &#8212; XSS 脆弱性に弱いので自由に JS 書けない
* クロスドメイン通信 &#8211; ヘッダを iframe 化することでログイン時のメニューを表示
* フィードバックシステム &#8211; iframe で表示するヘッダに設置する &#8211; 運営への意見をフィードバックする際に、ユーザがどのページにいるかを一緒に送れる
* アクセスコントロール &#8211; ユーザの自由な認証設定に応じていきたい &#8212; 一方で認証の仕組みが複雑になってしまう &#8211; ブログごとに閲覧用 cookie を発行することで対応
* はてな記法++ &#8211; ブラケットを [.. から < ..> に変更 &#8212; タグとして解釈可能となり style 属性付与ができたりする
* キャッシュ戦略 &#8211; なるべく外側でキャッシュする &#8211; キャッシュに依存しない作りにする &#8211; 基本はページまるごとキャッシュ

* * *

## Webアプリでパスワード保護はどこまでやればいいか

「[安全なWebアプリケーションの作り方][6]」の著者、徳丸浩 ([@ockeghem][7]) さんの講演。同本の 5.1 章を解説する流れで説明されていましたが、RainbowTable などの説明がとてもわかり易かったです。

### 本日のテーマ

**単に HASH 化しただけでは元に戻せるのか？** - クラックは 2 種類 &#8211; オンラインクラック : リモートからのパスワード試行 &#8211; オフラインクラック : 情報を盗み、攻撃者の手元で平文パスワードを求める - パスワードだけ保護する理由とは？ &#8211; パスが漏れてれば他の個人情報も漏れている &#8211; パスワードを使いまわす利用者もいる &#8211; パスワード保護は運営者の義務

### オンラインクラック

* パターン &#8211; 総あたり攻撃 : 時間かかるのであまりやらない &#8211; 辞書攻撃 : 辞書のものを順にパスワードとして試行 &#8211; その他のバリエーション &#8212; ジョーアカウント探索 : ID と pass を同じにしているものを総あたりで試行 &#8212; 逆総当り攻撃 : パスワード固定でユーザを変える &#8212;- 普通の総当りに比べて成功確率高い &#8212;- Twitter のような ユーザ ID がわかっているようなものは特に
* 対策 &#8211; 強いパスワードを付けてもらう &#8211; アカウントロックが基本 &#8211; ジョーアカウントは登録時にチェック &#8211; 逆総あたり対策として、辞書のものは NG にする

### オフラインクラック

* なぜ暗号化ではなくハッシュなの？ &#8211; 暗号化は鍵管理が難しいが、ハッシュは鍵管理が不要
* ハッシュは安全？ &#8211; 一般的にはハッシュ値から平文を「復元する」ことはできない &#8211; パスワードの場合は特別な事情がある &#8212; 短い文字列 &#8212; 文字種限られている
* ハッシュから平文に戻す方法 &#8211; 総当たり攻撃・辞書攻撃 &#8212; オフライン型のパスワードクラックツール &#8212;- GPU 高速化に伴ってかなり高速にできるようになった &#8211; RainbowTable &#8212; 逆引き表 + 還元関数でチェーンを作る &#8212;- 単純な逆引き表は膨大なデータ量 &#8212;- 圧縮するために還元関数を使う &#8212; チェーンの「先頭」と「末尾」だけ保存すればいい &#8212; 探索はハッシュに還元関数をかけていって「末尾」と一致するかどうかを見ればいい &#8212;- 一致したらその「先頭」がパスワード &#8212; どのアルゴリズムでも実現できる &#8212;- アルゴリズム特有の脆弱性を使っていない &#8211; Salt &#8212; ハッシュの元データに追加する文字列 &#8212;- 見かけのパスワードの長さを長くする &#8212; ユーザごとにソルトを変えることでパスワードが同じでも異なるハッシュ値を得られる &#8211; Streching &#8212; ハッシュの計算を繰り返ことで、ハッシュ計算を遅くする &#8212; メリット／デメリットある

## パスワードの暗号化は本当に無理か

* HSM (Hardware Security Module) ならばいける &#8211; 復号化機能を無効にできればよい

* * *

## Perl で構築された中規模サイトの DC 引っ越し記録

※講演資料 <a href=&#8221;http://dl.dropbox.com/u/224433/YAPC2011/index.html KAYAC の sfujiwara ([@sfujiwara][8]) さんの講演。&#8221;こえ部&#8221; をレンタルサーバから自社インフラに移設した時のまとめを紹介されていました。アップロードデータのあるサービスで新しいファイルを旧環境でケアしてあげる方法は難しそうですが、Nginx の効率のよい使い方などは参考になりました。

### こえ部 & システム概要

* 音声投稿共有サイト
* 機能 &#8211; flash + kamaitachi でブラウザからその場で録音 &#8211; メール添付 &#8211; &#8220;こえ部 Live!&#8221; は Red5 + AnyEvent
* ユーザ数 42万
* 100万 PV/day 
* UU 20,000 人
* Traffic &#8211; Outgoing : Max 70 Mbps &#8211; Inbound : Max 25 Mbps
* もともとレンタルサーバを組み合わせてやっていた
* サーバ増設 + SPOF整理しながら自社インフラに移設 &#8211; 同時に KVM 環境に移行

### 旧システムと新システムのアーキテクチャ

* HAProxy &#8211; App サーバの local に HAProxy &#8212; 3306 : MySQL master &#8212; 3307 : MySQL slave &#8212; 同様に KyotoTycoon も設定
* 今も残っている SPOF &#8211; MySQL master &#8212; MHA を試すとか？ &#8211; NFS

### 止めずに移行するための準備と仕掛け

* 段階的に切り替えたかった
* 手順 &#8211; 新サーバ群立ち上げ &#8212; 合わせてチューニング &#8212;- mk-duplicate-key-checker &#8212; ファイル書き込みの job は新旧それぞれで別々の worker が処理 &#8212; 旧環境にないファイルは Nginx の error_page を使って内部で reverse proxy &#8211; DC 間に VPN &#8212; OpenVPN で構築 &#8212; 100 Mbps 回線で RTT 3-4 ms / スループット 60Mbps &#8211; データ・トラフィックを VPN 経由で移す &#8211; サービス IP を DNS で切り替え &#8212; サービス停止は 1 時間くらいで

### 実際の移行作業顛末

* 4 日に分けて処理して無事終了
* ユーザクレームは作業に関係しない箇所のみ &#8211; ユーザにとってのメンテナンスは「不満だった部分が解消される」という期待になる

* * *

## Mobage オープンプラットフォームの事件簿

DeNA の zigorou ([@zigorou][9]) さんの講演。モバゲーオープンプラットフォームの障害事例とその対処法についてのお話でした。大規模サービスの障害事例はとても参考になります。「原因究明」「失敗防止」「知識配布」という項目でまとめているのもわかりやすかったですし、これらの障害報告会を社内で定期的に行なって共有する体制を作っているのはとても良いことだと思いました。

### DeadLock 多発事件

* ある API が突然 DeadLoak が多発するようになった &#8211; もともと Transaction が比較的長い処理だった
* 原因究明 &#8211; 特定の UPDATE 文が原因 &#8212; 件数カウントのために TRIGGER で summary 作っていた部分 &#8211; 対象データセットに Group という概念があった &#8212; 特定のデータ群をカテゴライズしていた &#8212; 特定の Group に集中してしまうと DEADLOCK になってしまう
* 失敗防止 &#8211; Trigger ではなく Queue として扱う &#8212; Queue から 100 件とりだして UPDATE 文つくる
* 知識配布 &#8211; アプリに人気が偏るとデータが集中する &#8212; 設計やモデリングで予見できた障害かもしれない &#8211; Queue のときは Index 不要なのではらない

### INSERT vs DELETE

* ある API の古いデータを消そうとしたが DELETE が INSERT に追いつかない
* 原因処理 &#8211; PURGE 処理 &#8212; master で全力で DELETE すると slave 遅延する &#8212; よくやるのは DB 負荷にかかわらず一律の weight 入れる &#8211; Loop::Sustainable &#8212; 適切な weight をいれてくれる &#8211; SET SQL\_LOG\_BIN = 0 &#8211; もっと発想を豊かに &#8212; おかわり作戦 &#8212; 余計なデータを PURGE した新しい系統にいれる
* 失敗防止 &#8211; 極力速く DELETE できる schema を &#8212; DELETE していくのはほぼ無理 &#8212; 構造考えて PARTITIONING をするべき &#8211; ダメなら消し込んでデータ入れ替え
* 知識配布 &#8211; おかわり作戦 &#8212; DB 運用すると発生する Flagmentation の対策にも鳴る

### 有名人問題

* 有名人ユーザでレスポンス低下したりする
* 原因究明 &#8211; 取得件数が異常に多い &#8212; TemporaryTable が作られている
* 失敗防止 &#8211; SQL\_CALC\_FOUND_ROWS / TemporaryTable は重い &#8212; ユーザを順次取得してやってみる &#8211; Iterator::GroupedRows

### まとめ

* 失敗から得られることは大きい
* スピンアウトで新しいものできる
* 分業大事
* 失敗に対して常に問題

* * *

## Mobageソーシャルゲームにおける大規模サーバ運用 with Perl

DeNA の riywo ([@riywo][10]) さんの講演。DeNA の内製 SNG の運営におけるチューニングのお話でした。台数が増えると起きてくる問題や、人気が出てイベントなどでアクセスが集中すると起きる問題など、そのアプローチが参考になりました。DevOps 的な問題点についても、規模は小さいながらも同じような状況を見ている立場としてとても共感できるものでした。

### Application Tuning

* アプリケーション台数は多い &#8211; それぞれからつなぐ先を減らすほうが良い
* 2 つの接続インターフェイスの改善 &#8211; Resolving Module &#8212; DNS での名前解決で失敗するとサービスに影響が出る &#8212; application が MyDNS の中身をまるごとキャッシュ &#8212;- アプリで dns weight みてバランシング &#8212;- DNS 全滅した場合でもローカルキャッシュでしばらく動く &#8211; Handler Socket &#8212; ユーザデータをキャッシュせず直接 DB に取りに行く &#8212; アプリケーション CPU の負荷が下がり高速化した &#8212;- memcached の consistent hash の計算で意外と使ってた
* 現在のアプリへの &#8220;追加&#8221; は簡単にできる &#8211; インパクトが大きな箇所のところだけ置き換えればいい &#8211; チューニングしたいところだけピンポイントで入れられる

### Database Tuning

* 一気に成長することで問題が顕在化
* DB 分割を繰り返してきた &#8211; 多くの場合は DB 容量の問題が大きく影響 &#8211; database handle を追加して切り替え &#8212; config で同じところを見続けるようにしておく &#8212; メンテナンスで指し先を切り替える
* 怪盗ロワイヤルのイベント &#8211; 同じお宝を奪い合うにしてみた &#8211; ユーザを探す所が重くなった &#8212; レベルが近い順に探していくため &#8212; レベルのカラム構造を変えて、ざっくりの level-class をつけるようにした &#8211; Lock wait timeout 発生 &#8211; DeadLock 起きにくくする &#8212; ロックを取得する順番を決める &#8211; イベントをすることで既存機能に影響することがある

### DevOps

* イベント開始がシェアされてなかった &#8211; シェアされてても全部の問題が予測できるわけではないけど。。。
* それぞれの視点で問題を考えてアプローチする &#8211; Dev &#8211; Ops
* ちょっとしたプロジェクトマネジメントとして考えている

* * *

LT もレベルが高く面白い発表ばかりだったのですが、聞くことに専念していたのでメモとってませんでした。。。 そして前夜祭のメモまとめてないことに気づいたのであとでまとめます。

2 日目につづく。

 [1]: http://yapcasia.org/2011/ "YAPC::Asia"
 [2]: http://twitter.com/obra
 [3]: http://ma.la/files/yapcasia2011/#0
 [4]: http://twitter.com/bulkneets
 [5]: http://twitter.com/yasuhiro_onishi
 [6]: http://www.amazon.co.jp/%E4%BD%93%E7%B3%BB%E7%9A%84%E3%81%AB%E5%AD%A6%E3%81%B6-%E5%AE%89%E5%85%A8%E3%81%AAWeb%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9-%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%8C%E7%94%9F%E3%81%BE%E3%82%8C%E3%82%8B%E5%8E%9F%E7%90%86%E3%81%A8%E5%AF%BE%E7%AD%96%E3%81%AE%E5%AE%9F%E8%B7%B5-%E5%BE%B3%E4%B8%B8-%E6%B5%A9/dp/4797361190
 [7]: http://twitter.com/ockeghem
 [8]: http://twitter.com/sfujiwara
 [9]: http://twitter.com/zigorou
 [10]: http://twitter.com/riywo
