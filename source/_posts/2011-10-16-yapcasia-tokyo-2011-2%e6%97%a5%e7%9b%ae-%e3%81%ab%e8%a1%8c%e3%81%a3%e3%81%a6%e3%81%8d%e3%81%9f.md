---
title: YAPC::Asia Tokyo 2011 (2日目) に行ってきた
author: hatak
layout: post
permalink: /2011/10/16/6777
categories:
  - 行ってきた
tags:
  - perl
  - yapc
---

昨日に引き続いて、 [YAPC::Asia][1] に参加してきました。

個人的な視点で、今回の YAPC から感じた Perl とそれを取り巻く Web サービス系の世界の現状をいくつかまとめると、

* 前回参加した 2 年前に発表された PSGI はもはや標準
* プラットフォーマーを中心に大規模サービスのノウハウが溜まってきている
* アプリケーションの設計・実装でも、ミドルウェアやハードウェアも含めた視点がより大事になっている
* 組織が大きくなった会社では、開発者と運用者の良い関係づくり (DevOps の考え方) に取り組んでいる

といったところかなと思います。 会社で標準的に使われている開発言語が違っても、根底の考え方や Web サービス系全般での動きは同じだなと痛感しました。

<!--more-->

* * *

## 続 Unix Programming with Perl

※講演資料 [[No Title]][2] DeNA の kazuho ([@kazuho][3]) さんの講演。[前回][4]に引き続いて、Unix 環境で正しく動くコードを作るための Tips 紹介のトークでした。Unix の知識が足りずまだ理解が追いついていないので、調べて試さないとと感じた発表でした。

### 正しいコードを書くために

* テストだけでは足りない
* 常に正しく動くコードを書くためには知識が必要 &#8211; Perl の知識 &#8211; OS の知識

### IPC::Open3 によるプロセス間通信

* pipe したときにブロックしてしまうケースがある &#8211; 子プロセスが STDIN 待ちになる場合 &#8211; 子プロセスが大量のエラーを吐く場合 &#8212; pipe が制限を持っている &#8212;- MacOSX : 16 Kbyte &#8212;- Linux2.6 : 64 Kbyte
* deadlock とならないためには？ &#8211; クローズしてもうまくいかない &#8211; 標準出力全部読んでもうまくいかない &#8211; IPC::Open3 のオプションとして、標準エラー出力に undef いれる &#8211; pipe を使わず temporary file 使えばいい

### Unix signals と race condition (競合状態)

* POSIX::pselect &#8211; pselect の外で SIGHUP &#8212; 多くのディストーションでの実装がバグっているため、実際には解決しない &#8211; eval & die &#8212; これでもうまく解決しない &#8211; call syswrite on signal

## まとめ

* buffesize は無限大ではない
* shell invocation は危険なので system か IPC::Open3 を使う
* Unix signals のハンドリングでは競合に気をつける

* * *

## 運用しやすいWebアプリケーションの構築方法

※講演資料 [[No Title]][5] Livedoor の kazeburo ([@kazeburo][6]) さんの講演。これまでの運用経験を基に、運用しやすい Web アプリケーションとなるためのログや DBI / cache の使い方・Tips をまとめて紹介されていました。確かに、と思うポイントが多く、とても参考になるトークでした。

### 運用しやすいとは？

* 耐障害性を考慮に入れた設計
* アプリケーションからの情報発信
* 処理単位の明確化

### ログ

* 「アプリからの情報発信」 &#8211; 障害発生の際に最初に見る &#8211; 障害の検知、原因の特定
* 適切なログに含まれる情報 &#8211; 時間 &#8211; ログレベル &#8212; 基準を決めて &#8220;DEBUG&#8221;/&#8221;INFO&#8221;/&#8221;WARN&#8221;/&#8221;ERROR&#8221; を使い分ける &#8211; 環境 &#8212; pid や uid、引数など &#8211; caller / stacktrace &#8211; 読み取る人に伝わるメッセージ
* Log::Minimal &#8211; 上記の適切なログ基準に沿ってログを出せるようにした &#8211; シリアライズ / カラーリング なども可能

### DBI (SQL)

#### DB 負荷が急上昇するケース

* 原因クエリ探す
* なんのクエリかアプリで確認
* ORM を使っていると調べにくいこともある &#8211; SQL とコードが一致しなく鳴るため、SQL 生成を避けたい
* DBIx::Sunny &#8211; caller 情報を SQL に埋込みクエリコメントにできる &#8211; SQL::Maker と組み合わせて利用できる

#### 接続が滞留するケース

* 最大接続数に達して接続エラー &#8211; メンテナンス時に timeout まで待つ &#8211; SHOW INNODB STATUS が見れない
* 接続滞留対策 &#8211; Scope::Container &#8212; DB 接続部の処理単位を短く、わかりやすく &#8211; Scope::Container::DBI &#8212; 上記を簡単に実現するために便利機能を追加したモジュール

### cache / memcached

* 課題 &#8211; Session::Store::Memcached &#8212; 簡単で高速、Expires 処理も自動化できる &#8212; 一方でストレージ永続性がないのは困ることもある &#8211; 特定キャッシュへの集中 &#8212; 分散アルゴリズム上でも特定サーバに集中してしまうことがある &#8211; cache thundering herd problem &#8212; memcache 上で exipre した瞬間に DB にアクセスが集中してしまう
* Cache::Memcached::IronPlate &#8211; 冗長して保存することで cache の冗長性確保 &#8211; cache の負荷分散も行える
* Cache::Isorator &#8211; ゆっくり expire させることができる

### Metrics

* プロセスのステータスを取得できるようにしてグラフ化する &#8211; Plack::Middleware::ServerStatus::Lite &#8211; Parallel::Scoreboard

### まとめ

* 耐障害性を考慮に入れた設計 &#8211; cache &#8211; memcached
* アプリケーションからの情報発信 &#8211; DBI &#8211; ログ &#8211; Metrics
* 処理単位の明確化 &#8211; DBI connection

* * *

## watch your log

DeNA の nekokak ([@nekokak][7]) さんの講演。社内 DevOps の観点から基準を決めてログ出力し、それを監視するためのツールを作成したというお話。&#8221;DevOps&#8221; と &#8220;ログ監視&#8221; については各社でかなり試行錯誤しているところかもしれません。 ログ監視は最近色々考えていて自分で実装しようかなと思っているところだったので、Komainu も試してみます。あと、「必要に応じたエンジニアリング」というスタンスはいいなと思います。

### DevOps

* Dev と Ops 相互に協力する事が必要 &#8211; 自社 Dev は運用を考えられなければならない &#8211; 自社 Ops は Dev から渡される運用を丸受けしてはダメ
* Dev Ops の垣根取り払って密なコミュニケーションを
* 運用を考えられる Dev &#8211; 障害は一次対応が Ops のことが多い &#8211; 運用したことないミドルウェアを導入する場合は、事前に互いに調べて共有 &#8211; 仕様変更 / 新機能のリリースタイミングで共有を行う
* 丸受けしない Ops &#8211; サービス仕様・アーキテクチャを理解 &#8211; 障害発生時に何を対応する必要があるか理解 &#8211; 必要な情報は Dev に提出 &#8211; 「お母さん役みたいなもの」

### コミュニケーション濃度の問題

* お互いしっかりコミュニケーション取る
* コミュニケーションもレベル・粒度ある
* 「お互い言い分あるだろうが gdgd 言う前に行動しろ」

### 障害そして監視

* 障害検知の仕組みとして監視必要 &#8211; 死活監視 &#8211; リソース監視 &#8211; ログ監視

### ログ

* お互いで取り決めたフォーマットに沿ったログ出力 &#8211; Dev と Ops が面倒みるにあたって取り決めるといい
* accesslog / errorlog &#8211; 監視する項目の取り決めをしておく &#8211; ステータスコード監視でサービスがどのような状況か分かる
* applog (syslog) &#8211; フォーマットの取り決めが重要なところ &#8211; 障害レベルの分類をログレベルで出力するなどの取り決め &#8212; 携帯にメールか、会社のメールかでレベルか
* mysql slow log &#8211; だいたいボトルネックは DB のことが多い
* ログ収集方法 &#8211; ログを良い感じで監視できるソリューションがない

### Komainu

* 設定に応じて集計 &#8211; accesslog 集計 &#8211; applog 集計 &#8211; mysql slow log 集計
* アーキテクチャ &#8211; fork model &#8211; notify は IRC と Email &#8211; データは database に保存 &#8212; サマリ集計し、前回からどれくらい増えたか知りたい &#8212; グラフ化する &#8212; プロセス間通信せずにデータを受け渡す
* 何が重要か &#8211; サービスクオリティ維持のため &#8211; 利用者からの問い合わせベースで障害に気づくのは情けない &#8211; 攻めの運用 &#8211; ログ情報を通知することでエラーに向きあう

### **Shut the fuck up and write some code**

* 行動こそすべて
* 誰かが始めないと何も始まらない
* 問題意識を持った人が率先して行動 &#8211; コードの良し悪しなどはどうでもいい

* * *

## Managing A Band Of Hackers

DeNA の hidek ([@hidek][8]) さんの基調講演。Perl ハッカーを束ねるマネージャーとしての考え方や経験のお話でした。 とてもいい話でした。DeNA には優秀で著名な方が集まっているイメージがありますが、このようなコミュニティというか、仲間の魅力が根底にはあるのだろうなと感じる内容でした。途中、何度もチームを褒めているところが、率直に褒めているように感じられて印象的でした。

### management

* なぜマネージャーが必要？ &#8211; 一人では規模の限界
* 集団で物事を作るということ &#8211; バラバラに動くと個人個人のプレーになってしまう &#8211; 誰かが指揮する &#8211; これがマネージャー
* &#8220;The whole is more than the sum of its parts.&#8221; &#8211; 1 + 1 が 2 以上になるようにしなければならない

### tasks of the manager

* マネージャーの業務にはエンジニアとしての経験が必要 &#8211; 大規模なほど広いレイヤの知識が必要

#### project management

* プロダクトのライフサイクルを維持する &#8211; エンジニアリング未経験だと無理
* 計画を立てる
* 開発中の進捗・マイルストーン管理

#### personal matters

* 人事も大事
* 採用面接 &#8211; 見極める力が求められる
* 配属 &#8211; 仕事を与えるということ &#8211; その人の持ってる力などを見極めることが大切 &#8211; コミュニケーション能力も必要 &#8212; その人が何をしたいのかを聞く
* 評価 &#8211; どんな仕事をしたか、を見るためにもエンジニア経験が必要

#### etc

* 事務仕事
* 会議 &#8211; 無駄なものもあるが、最近必要と感じることもある &#8212; 海外支社とのテレビ会議など、図を書いたりすることで理解が早くなる &#8211; Face to Face も重要

### the manager of hackers

* 少しとんがった人たちのマネージャーとして
* Platform System Group &#8211; プロジェクト開始時は 3 名、現在 20 名 &#8211; CPAN Author が 6 名

#### hackers はどういう人達か

* &#8220;no man is an island&#8221; &#8211; 一人だと寂しくて死んじゃう
* get bored easily &#8211; 飽きっぽい &#8211; 餌を与え続ける
* priority < interest &#8211; つまらない仕事を与えつつも、先に楽しい仕事を用意しておく
* late morning, late nite &#8211; 働いている時間は一緒 &#8211; 裁量労働なので良いが、相談したいときにいつ来るかわからないのは困ることも
* KY &#8211; 読めない事自体は仕事に影響しないので、悪いことではない &#8211; 悪ノリする

### what should I do ?

* これはハッカーのマネージャーだけでなく、一般でも通じるところはある

#### delegation

* 仕事を任せる &#8211; 失敗もするけど、任せると成長する
* 自分でやっちゃおう、と思うこともある
* 「任せる」と「丸投げ」は違う &#8211; 任せるための準備はする &#8211; バックアッププランは作る &#8211; 失敗したらマネージャーが責任を持つ

#### bad news first

* 悪い報告を先にするようにしてもらう

#### TMTOWTDI

* やり方は一つではない &#8211; これはマネジメントだけではない
* 多様性を許容する

### マネージャが少ない会社は大変

* マネージャは優秀なエンジニアじゃないとできない &#8211; 選択肢として考えて欲しい

### コミュニティに参加して欲しい

* 技術的な刺激を受けられる
* 人脈を作る &#8211; マネージャとして重要 &#8211; 最終的には経験の糧になる

* * *

このほか、LT なども面白く刺激的なものが多く、とても良いカンファレンスでした。

次回がどのようになるかはまだ未定とのことでしたが、次回が YAPC::Asia どこで行われても参加したいと思っています。同時に、これまではカンファレンスやセミナーに参加しつつもずっと聞く側でしたが、今後は YAPC に限らず、もっとコミュニティ全般に対して積極的に貢献できる活動をしたいと思った 3 日間でした。

発表者、スタッフ、参加者、そしてスポンサー企業のみなさま、お疲れ様でした。

 [1]: http://yapcasia.org/2011/ "YAPC::Asia"
 [2]: http://www.slideshare.net/kazuho/unix-programming-with-perl-2
 [3]: http://twitter.com/kazuho
 [4]: http://www.slideshare.net/kazuho/unix-programming-with-perl
 [5]: http://www.slideshare.net/kazeburo/yapcasia2011
 [6]: http://twitter.com/kazeburo
 [7]: http://twitter.com/nekokak
 [8]: http://twitter.com/hidek
